{% extends "Cliente/base.html" %}
{% block title %}Meus Agendamentos{% endblock %}

{% block content %}
<main class="content">
  <div class="agendamentos-header">
    <h1>Meus Agendamentos</h1>
    <a href="{% url 'agendar-servico' %}" class="btn-novo-agendamento">Novo Agendamento</a>
  </div>

  {% if messages %}
  <div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
      {{ message }}
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {% if agendamentos %}
  <div class="table-container">
    <table class="table-agendamentos-cliente">
      <thead>
        <tr>
          <th>#</th>
          <th>Data/Hora</th>
          <th>Moto</th>
          <th>Serviço</th>
          <th>Descrição</th>
          <th>Mecânico</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for agendamento in agendamentos %}
        <tr>
          <td class="td-center">
            <strong>#{{ agendamento.id }}</strong>
          </td>
          <td>
            <div class="data-info">
              <strong>{{ agendamento.data_hora|date:"d/m/Y" }}</strong><br>
              <small>{{ agendamento.data_hora|date:"H:i" }}</small>
            </div>
          </td>
          <td>
            <strong>{{ agendamento.moto.marca }} {{ agendamento.moto.modelo }}</strong><br>
            <small>Ano: {{ agendamento.moto.ano }}</small>
          </td>
          <td>
            <strong>{{ agendamento.servico.nome }}</strong>
          </td>
          <td class="descricao-col">
            {% if agendamento.descricao_problema %}
            {{ agendamento.descricao_problema }}
            {% else %}
            <em style="color: #999;">Sem descrição</em>
            {% endif %}
          </td>
          <td>
            {% if agendamento.mecanico %}
            {{ agendamento.mecanico.nome_completo }}
            {% else %}
            <em style="color: #999;">Aguardando</em>
            {% endif %}
          </td>
          <td class="td-center">
            {% if agendamento.status == 'agendado' %}
            <span class="badge-agendado">Agendado</span>
            {% elif agendamento.status == 'em_andamento' %}
            <span class="badge-andamento">Andamento</span>
            {% endif %}
          </td>
          <td class="td-center">
            <div class="acoes-buttons">
              {% if agendamento.status == 'agendado' %}
              <a href="{% url 'remarcar-agendamento-cliente' agendamento.id %}" class="btn-remarcar"
                title="Remarcar agendamento">
                Remarcar
              </a>
              {% endif %}
              <button onclick="confirmarCancelamento({{ agendamento.id }})" class="btn-cancelar-agendamento"
                title="Cancelar agendamento">
                Cancelar
              </button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state">
    <h3>Nenhum agendamento ativo</h3>
    <p>Você não tem agendamentos pendentes no momento.</p>
    <a href="{% url 'agendar-servico' %}" class="btn-primary">
      Fazer Novo Agendamento
    </a>
  </div>
  {% endif %}
</main>

<!-- Modal de Confirmação de Cancelamento -->
<div id="modalCancelamento" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <h3>Confirmar Cancelamento</h3>
    <p>Tem certeza que deseja cancelar este agendamento?</p>
    <p class="modal-warning">Esta ação não pode ser desfeita.</p>
    <div class="modal-buttons">
      <button onclick="fecharModal()" class="btn-modal-cancelar">Não, voltar</button>
      <button onclick="cancelarAgendamento()" class="btn-modal-confirmar">Sim, cancelar</button>
    </div>
  </div>
</div>

<script>
  let agendamentoIdParaCancelar = null;

  function confirmarCancelamento(agendamentoId) {
    agendamentoIdParaCancelar = agendamentoId;
    document.getElementById('modalCancelamento').style.display = 'flex';
  }

  function fecharModal() {
    document.getElementById('modalCancelamento').style.display = 'none';
    agendamentoIdParaCancelar = null;
  }

  function cancelarAgendamento() {
    if (agendamentoIdParaCancelar) {
      window.location.href = `/cancelar-agendamento/${agendamentoIdParaCancelar}/`;
    }
  }

  // Fechar modal ao clicar fora
  document.getElementById('modalCancelamento').addEventListener('click', function (e) {
    if (e.target === this) {
      fecharModal();
    }
  });
</script>

{% endblock %}